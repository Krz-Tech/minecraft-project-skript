# -------------------------------------------------------------------------
# Module: Krz-Core Floating Display
# Author: Antigravity Agent
# Since: 2025-12-24
# Description: SkBee ã‚’ä½¿ç”¨ã—ãŸãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
# Note: Text Display ã®å‰Šé™¤ã«ã¯ delete ã§ã¯ãªã kill ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
# -------------------------------------------------------------------------

options:
	PREFIX: "&b[FloatingDisplay] &r"
	
function display_init():
	send "%{@PREFIX}%&aåˆæœŸåŒ–å®Œäº† (SkBee Text Display)" to console
	delete {-display::pending::*}
	
	# -------------------------------------------------------------------------
	# ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆã‚¹ãƒ­ãƒƒãƒˆãƒã‚·ãƒ³é¢¨ + è‰²å¤‰åŒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
	# -------------------------------------------------------------------------
function display_show_damage(loc: location, damage: number, is_crit: boolean):
	set {_rounded} to floor({_damage} * 10) / 10
	set {_offset_x} to random number between -0.3 and 0.3
	set {_offset_z} to random number between -0.3 and 0.3
	set {_display_loc} to {_loc}
	add {_offset_x} to x-coord of {_display_loc}
	add 2.2 to y-coord of {_display_loc}
	add {_offset_z} to z-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	if {_is_crit} is true:
	# ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«: é»„â†’ã‚ªãƒ¬ãƒ³ã‚¸â†’èµ¤ + ã‚¹ãƒ­ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
		set display scale of {_display} to vector(3.0, 3.0, 3.0)
		set display text of {_display} to "&e&lâš¡ -%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(2.5, 2.5, 2.5)
		set display text of {_display} to "&6&lâš¡ -%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(2.0, 2.0, 2.0)
		set display text of {_display} to "&c&lâš¡ -%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		set display text of {_display} to "&4&lâš¡ -%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.2, 1.2, 1.2)
	else:
	# é€šå¸¸: ç™½â†’ã‚ªãƒ¬ãƒ³ã‚¸ + ã‚¹ãƒ­ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
		set display scale of {_display} to vector(2.5, 2.5, 2.5)
		set display text of {_display} to "&f-%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(2.0, 2.0, 2.0)
		set display text of {_display} to "&e-%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		set display text of {_display} to "&6-%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.2, 1.2, 1.2)
		set display text of {_display} to "&c-%{_rounded}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.0, 1.0, 1.0)
		
		# è¡¨ç¤ºç¶­æŒ
	wait 1.5 seconds
	
	# ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
	set display scale of {_display} to vector(0.8, 0.8, 0.8)
	wait 2 ticks
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	set display scale of {_display} to vector(0.2, 0.2, 0.2)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
		# -------------------------------------------------------------------------
		# å›å¾©è¡¨ç¤ºï¼ˆç·‘ã®ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
		# -------------------------------------------------------------------------
function display_show_heal(loc: location, amount: number):
	set {_display_loc} to {_loc}
	add 2.2 to y-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	# æ˜ã‚‹ã„ç·‘â†’ç·‘ + ã‚¹ãƒ­ãƒƒãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
	set display scale of {_display} to vector(2.5, 2.5, 2.5)
	set display text of {_display} to "&a&lâœš %{_amount}%"
	wait 2 ticks
	set display scale of {_display} to vector(2.0, 2.0, 2.0)
	set display text of {_display} to "&2&lâœš %{_amount}%"
	wait 2 ticks
	set display scale of {_display} to vector(1.5, 1.5, 1.5)
	set display text of {_display} to "&aâœš %{_amount}%"
	wait 2 ticks
	set display scale of {_display} to vector(1.0, 1.0, 1.0)
	set display text of {_display} to "&2+ %{_amount}%"
	
	wait 1.5 seconds
	
	set display scale of {_display} to vector(0.8, 0.8, 0.8)
	wait 2 ticks
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
		# -------------------------------------------------------------------------
		# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºï¼ˆã‚·ã‚¢ãƒ³ç³»ãƒ‘ãƒ«ã‚¹ï¼‰
		# -------------------------------------------------------------------------
function display_show_status(loc: location, text: text, color: text):
	set {_display_loc} to {_loc}
	add 2.0 to y-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	set display scale of {_display} to vector(2.5, 2.5, 2.5)
	set display text of {_display} to "&b&lÂ» %{_text}%"
	wait 2 ticks
	set display scale of {_display} to vector(2.0, 2.0, 2.0)
	set display text of {_display} to "&3&lÂ» %{_text}%"
	wait 2 ticks
	set display scale of {_display} to vector(1.5, 1.5, 1.5)
	set display text of {_display} to "%{_color}%Â» %{_text}%"
	wait 2 ticks
	set display scale of {_display} to vector(1.0, 1.0, 1.0)
	set display text of {_display} to "%{_color}%%{_text}%"
	
	wait 1.5 seconds
	
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
		# -------------------------------------------------------------------------
		# ENå¤‰å‹•è¡¨ç¤ºï¼ˆé’/é»„è‰²ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼é¢¨ï¼‰
		# -------------------------------------------------------------------------
function display_show_en_change(loc: location, amount: number):
	set {_display_loc} to {_loc}
	add 1.8 to y-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	set display scale of {_display} to vector(2.0, 2.0, 2.0)
	
	if {_amount} > 0:
		set display text of {_display} to "&b&lâš¡ +%{_amount}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		set display text of {_display} to "&3âš¡ +%{_amount}% EN"
		wait 2 ticks
		set display scale of {_display} to vector(1.0, 1.0, 1.0)
		set display text of {_display} to "&b+%{_amount}% EN"
	else:
		set display text of {_display} to "&e&lâš¡ %{_amount}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		set display text of {_display} to "&6âš¡ %{_amount}% EN"
		wait 2 ticks
		set display scale of {_display} to vector(1.0, 1.0, 1.0)
		set display text of {_display} to "&e%{_amount}% EN"
		
	wait 1 second
	
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
		# -------------------------------------------------------------------------
		# ã‚¹ã‚¿ãƒƒã‚¬ãƒ¼è¡¨ç¤ºï¼ˆè¡æ’ƒçš„ãªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
		# -------------------------------------------------------------------------
function display_show_stagger(loc: location, type: text, value: number):
	set {_display_loc} to {_loc}
	add 2.2 to y-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	if {_type} is "break":
	# ã‚¹ã‚¿ãƒƒã‚¬ãƒ¼ãƒ–ãƒ¬ã‚¤ã‚¯: æ¿€ã—ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
		set display scale of {_display} to vector(4.0, 4.0, 4.0)
		set display text of {_display} to "&e&lACS Overload!!!"
		wait 2 ticks
		set display scale of {_display} to vector(3.0, 3.0, 3.0)
		set display text of {_display} to "&6&lACS Overload!!!"
		wait 2 ticks
		set display scale of {_display} to vector(2.5, 2.5, 2.5)
		set display text of {_display} to "&c&lACS Overload!!!"
		wait 2 ticks
		set display scale of {_display} to vector(2.0, 2.0, 2.0)
		set display text of {_display} to "&4&lACS Overload!!!"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		wait 2 seconds
	else:
	# ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè“„ç©
		set display scale of {_display} to vector(2.0, 2.0, 2.0)
		set display text of {_display} to "&e&l+%{_value}%"
		wait 2 ticks
		set display scale of {_display} to vector(1.5, 1.5, 1.5)
		set display text of {_display} to "&6+%{_value}% IMPACT"
		wait 2 ticks
		set display scale of {_display} to vector(1.0, 1.0, 1.0)
		wait 1 second
		
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
		# -------------------------------------------------------------------------
		# ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ’ãƒƒãƒˆè¡¨ç¤ºï¼ˆç‰¹å¤§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰
		# -------------------------------------------------------------------------
function display_show_direct_hit(loc: location, damage: number):
	set {_rounded} to floor({_damage} * 10) / 10
	set {_display_loc} to {_loc}
	add 2.0 to y-coord of {_display_loc}
	
	spawn text display at {_display_loc}
	set {_display} to last spawned entity
	set display billboard of {_display} to center
	set {_id} to random integer between 100000 and 999999
	set {-display::pending::%{_id}%} to {_display}
	
	# é»„â†’ã‚ªãƒ¬ãƒ³ã‚¸â†’èµ¤ã®æ¿€ã—ã„ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
	set display scale of {_display} to vector(4.0, 4.0, 4.0)
	set display text of {_display} to "&e&lğŸ’¥ DIRECT!"
	wait 2 ticks
	set display scale of {_display} to vector(3.5, 3.5, 3.5)
	set display text of {_display} to "&6&lğŸ’¥ DIRECT HIT!"
	wait 2 ticks
	set display scale of {_display} to vector(3.0, 3.0, 3.0)
	set display text of {_display} to "&c&lğŸ’¥ %{_rounded}%"
	wait 2 ticks
	set display scale of {_display} to vector(2.5, 2.5, 2.5)
	set display text of {_display} to "&4&lğŸ’¥ DIRECT HIT! %{_rounded}%"
	wait 2 ticks
	set display scale of {_display} to vector(2.0, 2.0, 2.0)
	
	wait 2 seconds
	
	set display scale of {_display} to vector(1.0, 1.0, 1.0)
	wait 2 ticks
	set display scale of {_display} to vector(0.5, 0.5, 0.5)
	wait 2 ticks
	
	if {-display::pending::%{_id}%} is set:
		kill {-display::pending::%{_id}%}
		clear {-display::pending::%{_id}%}
		
on load:
	display_init()
	
command /testdamage [<number=50>] [<boolean=false>]:
	permission: op
	trigger:
		set {_loc} to location of player
		add 2 to y-coord of {_loc}
		display_show_damage({_loc}, arg-1, arg-2)
		send "%{@PREFIX}%&aãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: %arg-1% (Crit: %arg-2%)" to player
		
command /teststatus [<text=+50 HP>]:
	permission: op
	trigger:
		set {_loc} to location of player
		display_show_status({_loc}, arg-1, "&a")
		send "%{@PREFIX}%&aã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: %arg-1%" to player
		
command /testheal [<number=25>]:
	permission: op
	trigger:
		set {_loc} to location of player
		display_show_heal({_loc}, arg-1)
		send "%{@PREFIX}%&aãƒ’ãƒ¼ãƒ«è¡¨ç¤ºãƒ†ã‚¹ãƒˆ: +%arg-1%" to player
		
command /teststagger [<text=break>]:
	permission: op
	trigger:
		set {_loc} to location of player
		if arg-1 is "break":
			display_show_stagger({_loc}, "break", 0)
			send "%{@PREFIX}%&aã‚¹ã‚¿ãƒƒã‚¬ãƒ¼ãƒ–ãƒ¬ã‚¤ã‚¯è¡¨ç¤ºãƒ†ã‚¹ãƒˆ" to player
		else:
			display_show_stagger({_loc}, "impact", 15)
			send "%{@PREFIX}%&aã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè¡¨ç¤ºãƒ†ã‚¹ãƒˆ" to player
			
command /testdirecthit [<number=100>]:
	permission: op
	trigger:
		set {_loc} to location of player
		display_show_direct_hit({_loc}, arg-1)
		send "%{@PREFIX}%&aãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒ’ãƒƒãƒˆè¡¨ç¤ºãƒ†ã‚¹ãƒˆ: %arg-1%" to player
		
command /cleardisplays:
	permission: op
	trigger:
		execute console command "kill @e[type=minecraft:text_display]"
		delete {-display::pending::*}
		send "%{@PREFIX}%&cå…¨ã¦ã® Text Display ã‚’å‰Šé™¤ã—ã¾ã—ãŸ" to player
		
		# -------------------------------------------------------------------------
		# Event: å›å¾©æ™‚ã«ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å›å¾©ã‚’è¡¨ç¤º
		# -------------------------------------------------------------------------
on heal:
	set {_amount} to heal amount
	if {_amount} <= 0:
		stop
	set {_loc} to location of event-entity
	display_show_heal({_loc}, {_amount})